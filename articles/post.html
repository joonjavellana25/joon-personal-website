<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article | Joonjavellana</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/articles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- SEO: Open Graph & Twitter (placeholders updated dynamically) -->
    <meta property="og:title" content="Article | Joonjavellana">
    <meta property="og:description" content="">
    <meta property="og:type" content="article">
    <meta property="og:url" content="">
    <meta property="og:image" content="/assets/img/001-mac.jpeg">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Article | Joonjavellana">
    <meta property="twitter:description" content="">
    <meta property="twitter:url" content="">
    <meta property="twitter:image" content="/assets/img/001-mac.jpeg">
    <link rel="canonical" href="">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo underline-none uppercase text-bold">Joonjavellana</a>
            <ul class="nav-links">
                <li><a href="/" class="text-bold">Home</a></li>
                <li><a href="/#about" class="text-bold">About</a></li>
                <li><a href="/#projects" class="text-bold">Projects</a></li>
                <li><a href="/articles/" class="text-bold active">Articles</a></li>
            </ul>
        </div>
    </nav>

    <main class="container article-list article-container max-w-screen-md lg:max-w-screen-lg xl:max-w-screen-xl">
        <section class="p-8 px-2 md:px-3 lg:px-4 relative">
            <header class="flex justify-start">
                <button onclick="window.history.back()" class="btn btn-primary px-4 py-2 mt-4">
                    &larr; <span class="text-lg">Back</span>
                </button>
                <button onclick="window.location.href='/articles/'" class="btn btn-primary px-4 py-2 mt-4">
                    Articles
                </button>
            </header>
            <article class="article-preview">
                <div id="article-body" class="article-body article-content"></div>
            </article>
            <div id="article-meta" class="article-meta"></div>
            <div id="article-comments" class="article-comments"></div>
        </section>
        <!-- center align back button -->
        <div class="flex justify-center">
            <button onclick="window.history.back()" class="btn btn-primary px-4 py-2 mt-4">
                &larr; <span class="text-lg">Back</span>
            </button>
            <button onclick="window.location.href='/articles/'" class="btn btn-primary px-4 py-2 mt-4">
                Articles
            </button>
        </div>
    </main>


    <script>
        // Wait for marked.js to be loaded
        function loadArticle() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const id = urlParams.get('id');

            const showRemovedMsg = () => {
                document.getElementById('article-body').innerHTML = '<p>This post has been removed or failed to load.</p>';
            };

            const updateMeta = ({ title, description, image }) => {
                const pageTitle = title ? `${title} | Joonjavellana` : 'Article | Joonjavellana';
                const url = window.location.href;
                const img = image || '/assets/img/001-mac.jpeg';

                document.title = pageTitle;

                const set = (sel, val) => {
                    const el = document.querySelector(sel);
                    if (el) el.setAttribute('content', val || '');
                };
                const setHref = (val) => {
                    let link = document.querySelector('link[rel="canonical"]');
                    if (!link) {
                        link = document.createElement('link');
                        link.rel = 'canonical';
                        document.head.appendChild(link);
                    }
                    link.href = val || '';
                };

                set('meta[property="og:title"]', pageTitle);
                set('meta[property="og:description"]', description || '');
                set('meta[property="og:url"]', url);
                set('meta[property="og:image"]', img);

                set('meta[property="twitter:title"]', pageTitle);
                set('meta[property="twitter:description"]', description || '');
                set('meta[property="twitter:url"]', url);
                set('meta[property="twitter:image"]', img);

                setHref(url);
            };

            // Validate id exists and resembles a safe slug/filename
            if (!id || /[^a-z0-9\-]/i.test(id)) {
                showRemovedMsg();
                updateMeta({ title: 'Article', description: 'This post has been removed or failed to load.' });
                return;
            }

            const mdPath = `/articles/markdown/${id}.md`;

            // Prefetch metadata for SEO (title/description) from articles.json
            let metaPromise = fetch('/data/articles.json')
                .then(r => r.ok ? r.json() : [])
                .catch(() => []);

            fetch(mdPath)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                // Guard against empty files
                if (!data || !data.trim()) {
                    throw new Error('Empty content');
                }

                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    smartypants: true
                });

                const article = marked.parse(data);
                document.getElementById('article-body').innerHTML = article;

                // Update SEO metadata
                metaPromise.then(list => {
                    const found = Array.isArray(list) ? list.find(a => a.id === id) : null;
                    const title = found?.title || (document.querySelector('h1')?.innerText || 'Article');
                    const description = found?.description || '';
                    const image = found?.image;
                    updateMeta({ title, description, image });
                });
            })
            .catch(error => {
                console.error('Error loading article:', error);
                showRemovedMsg();
                updateMeta({ title: 'Article', description: 'This post has been removed or failed to load.' });
            });
        }

        // Check if marked is already loaded
        if (window.marked) {
            loadArticle();
            
            // Update page title with article title
            const metaTitle = document.querySelector('meta[property="og:title"]');
            const articleTitle = document.querySelector('h1 a');
            if (articleTitle && metaTitle) {
                metaTitle.setAttribute('content', articleTitle.innerText);
                document.title = articleTitle.innerText + ' | Joonjavellana';
            }
            

        } else {
            // If not, wait for it to load
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            script.onload = loadArticle;
            script.onerror = () => {
                console.error('Failed to load marked.js');
                document.getElementById('article-body').innerHTML = '<p>Error loading content. Please try again later.</p>';
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
